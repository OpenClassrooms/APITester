name: Code Analysis

on:
    pull_request: ~
    push:
        branches:
            - master

jobs:
    static-analysis:
        name: ${{ matrix.actions.name }}
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                actions:
                    -   name: PHPStan
                        run: composer phpstan --ansi

                    -   name: Psalm
                        run: composer psalm --ansi

                    -   name: Ecs
                        run: composer check-cs --ansi
        steps:
            -   uses: actions/checkout@v2

            -   uses: shivammathur/setup-php@v2
                with:
                    php-version: 7.4
                    coverage: pcov
                    tools: composer:v2

            #            -   name: Get composer cache directory
            #                id: composer-cache
            #                run: echo "::set-output name=dir::$(composer config cache-files-dir)"
            #
            #            -   name: Cache dependencies
            #                uses: actions/cache@v2
            #                with:
            #                    path: ${{ steps.composer-cache.outputs.dir }}
            #                    key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
            #                    restore-keys: ${{ runner.os }}-composer-

            -   name: Install dependencies
                run: composer install --prefer-dist --no-progress

            -   run: ${{ matrix.actions.run }}


    unit-test:
        name: PHPUnit & Coverage
        runs-on: ubuntu-latest
        needs: static-analysis
        env:
            XDEBUG_MODE: coverage
        steps:
            -   uses: actions/checkout@v2

            -   uses: shivammathur/setup-php@v2
                with:
                    php-version: 7.4
                    coverage: pcov
                    tools: composer:v2

            -   name: Install dependencies
                run: composer install --prefer-dist --no-progress

            -   name: PhpUnit
                run: composer unit

            -   name: Compare with base coverage
                uses: OpenClassrooms/coverage-checker@v1.6.0
                with:
                    action: check
                    token: ${{ secrets.GITHUB_TOKEN }}
                if: ${{ github.event_name == 'pull_request' }}

            -   name: Update base coverage
                uses: OpenClassrooms/coverage-checker@v1.6.0
                with:
                    action: check
                    token: ${{ secrets.GITHUB_TOKEN }}
                if: ${{ github.event_name == 'push' && github.ref_name == 'polish-finish' }}
